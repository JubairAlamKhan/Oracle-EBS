
--(1) User with responibilities and securtiy group

SELECT 
    FU.USER_NAME,
    FA.APPLICATION_SHORT_NAME,
    FRT.RESPONSIBILITY_NAME,
    FR.RESPONSIBILITY_KEY,
    FSG.SECURITY_GROUP_KEY
FROM 
    FND_USER_RESP_GROUPS_ALL  FUL,
    FND_USER FU,
    FND_RESPONSIBILITY_TL FRT,
    FND_RESPONSIBILITY FR,
    FND_SECURITY_GROUPS FSG,
    FND_APPLICATION FA
WHERE 1=1     
    AND FU.USER_ID = FUL.USER_ID
    AND FRT.RESPONSIBILITY_ID = FUL.RESPONSIBILITY_ID
    AND FR.RESPONSIBILITY_ID = FRT.RESPONSIBILITY_ID
    AND FSG.SECURITY_GROUP_ID = FUL.SECURITY_GROUP_ID
    AND FA.APPLICATION_ID = FUL.RESPONSIBILITY_APPLICATION_ID
    AND FRT.LANGUAGE = 'US'
    AND FU.USER_NAME =:EMP_ID;

--(2) User with designation, module, responsibilities and securtiy group

SELECT 
    FU.USER_NAME,
    SUBSTR(PAP.NAME, INSTR(PAP.NAME,'.',1,3)+1 ,(INSTR(PAP.NAME,'.',1,4)- (INSTR(PAP.NAME,'.',1,3)+1) )) DESIGNATION,
    FA.APPLICATION_SHORT_NAME,
    FRT.RESPONSIBILITY_NAME,
    FR.RESPONSIBILITY_KEY,
    FSG.SECURITY_GROUP_KEY
FROM 
    FND_USER_RESP_GROUPS_ALL FUL,
    FND_USER  FU,
    FND_RESPONSIBILITY_TL FRT,
    FND_RESPONSIBILITY FR,
    FND_SECURITY_GROUPS FSG,
    FND_APPLICATION FA,
    PER_ALL_PEOPLE_F PAPF,
    PER_ALL_ASSIGNMENTS_F PAAF,
    PER_ALL_POSITIONS PAP       
WHERE 1=1    
    AND  PAAF.POSITION_ID=PAP.POSITION_ID
    AND PAPF.PERSON_ID=PAAF.PERSON_ID
    AND PAAF.PERSON_ID = FU.EMPLOYEE_ID
    AND FU.USER_ID = FUL.USER_ID
    AND FRT.RESPONSIBILITY_ID = FUL.RESPONSIBILITY_ID
    AND FR.RESPONSIBILITY_ID = FRT.RESPONSIBILITY_ID
    AND FSG.SECURITY_GROUP_ID = FUL.SECURITY_GROUP_ID
    AND FA.APPLICATION_ID = FUL.RESPONSIBILITY_APPLICATION_ID
    AND FRT.LANGUAGE = 'US'
    AND FU.USER_NAME = :EMP_ID;

---(3) Employee info

SELECT 
    PAPF.FULL_NAME,
    PAPF.ATTRIBUTE5 PHONE,
    PAPF.EMAIL_ADDRESS,
    PAPF.EMPLOYEE_NUMBER,
    FU.USER_ID,
    PAPF.PERSON_ID,
    PAPF.NATIONAL_IDENTIFIER,
    PAAF.EFFECTIVE_START_DATE START_DATE,
    PAAF.EFFECTIVE_END_DATE END_DATE,
    CASE  
        WHEN PAAF.EFFECTIVE_END_DATE > SYSDATE THEN 'ACTIVE'
        ELSE  'LEFT'
    END STATUS,
    CASE  
        WHEN PAAF.EFFECTIVE_END_DATE > SYSDATE THEN 
                TO_CHAR(TRUNC ((MONTHS_BETWEEN(SYSDATE,PAAF.EFFECTIVE_START_DATE))/12)) || ' Years ' || 
                TO_CHAR(TRUNC(MONTHS_BETWEEN(SYSDATE,PAAF.EFFECTIVE_START_DATE))
                                - TRUNC ((MONTHS_BETWEEN(SYSDATE,PAAF.EFFECTIVE_START_DATE))/12)*12) || ' Months ' ||
                 TO_CHAR(TRUNC(SYSDATE) 
                                - ADD_MONTHS(PAAF.EFFECTIVE_START_DATE, TRUNC(MONTHS_BETWEEN(SYSDATE,PAAF.EFFECTIVE_START_DATE)))) || ' Days'              
        ELSE TO_CHAR(TRUNC ((MONTHS_BETWEEN(PAAF.EFFECTIVE_END_DATE,PAAF.EFFECTIVE_START_DATE))/12)) || ' Years ' || 
                TO_CHAR(TRUNC(MONTHS_BETWEEN(PAAF.EFFECTIVE_END_DATE,PAAF.EFFECTIVE_START_DATE))
                                - TRUNC ((MONTHS_BETWEEN(PAAF.EFFECTIVE_END_DATE,PAAF.EFFECTIVE_START_DATE))/12)*12) || ' Months ' ||
                 TO_CHAR(TRUNC(PAAF.EFFECTIVE_END_DATE) 
                                - ADD_MONTHS(PAAF.EFFECTIVE_START_DATE, TRUNC(MONTHS_BETWEEN(PAAF.EFFECTIVE_END_DATE,PAAF.EFFECTIVE_START_DATE)))) || ' Days'  
    END WOKING_YEARS
FROM 
    PER_ALL_PEOPLE_F PAPF,
    PER_ALL_ASSIGNMENTS_F PAAF,
    PER_ALL_POSITIONS PAP,
    FND_USER FU
WHERE     
    PAPF.PERSON_ID = PAAF.PERSON_ID
    AND PAPF.PERSON_ID = FU.EMPLOYEE_ID
    AND PAAF.POSITION_ID = PAP.POSITION_ID       
    AND PAPF.CURRENT_EMPLOYEE_FLAG = 'Y'
    AND PAAF.PRIMARY_FLAG = 'Y'
    AND TRUNC (SYSDATE) BETWEEN TRUNC (PAPF.EFFECTIVE_START_DATE)
           AND TRUNC (PAPF.EFFECTIVE_END_DATE)
    AND TRUNC (SYSDATE) BETWEEN TRUNC (PAAF.EFFECTIVE_START_DATE)
           AND TRUNC (PAAF.EFFECTIVE_END_DATE)
    AND ((UPPER (SUBSTR (PAP.NAME,INSTR (PAP.NAME, '.',3, 2) + 1,INSTR (SUBSTR (PAP.NAME,INSTR (PAP.NAME, '.',  3,2) + 1), '.', 1) - 1)) = UPPER(:DEPARTMENT))
           OR:DEPARTMENT IS NULL)                                             
    AND ((SUBSTR( PAPF.FULL_NAME,INSTR(PAPF.FULL_NAME,'KG-'))  = UPPER(:KG_ID)) 
            OR :KG_ID IS NULL) 
    AND (FU.USER_ID = :USER_ID OR :USER_ID IS NULL )        
ORDER BY 4; 

 
